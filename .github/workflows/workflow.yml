on: [push]

name: Rails CI
jobs:
  run:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis
        ports:
        - 6379:6379
      memcached:
        image: memcached
        ports:
        - 11211:11211
      postgres:
        image: postgres:10.8
        ports:
        - 5432:5432
        env:
          POSTGRES_PASSWORD: ""
      mysql:
        image: mysql:5.7
        ports:
        - 99:3306
        env:
          MYSQL_ROOT_PASSWORD: secret
    strategy:
      matrix:
        ruby: ["2.7", "3.0", "head"]
        gem:
        - activesupport
        - actionmailer
        - activemodel
        - actiontext
        - actionmailbox
        - actionview
        - actionpack
        - actioncable
        - activejob
        - activestorage
        - activerecord:postgresql
        - activerecord:sqlite3
        - activerecord:sqlite3_mem
        - activerecord:mysql2
        - guides
        - railties
      fail-fast: false
    name: ${{ matrix.ruby }} - ${{ matrix.gem }}
    steps:
    - name: Checkout
      uses: actions/checkout@master
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ matrix.ruby }}
        bundler-cache: true
    - name: Install libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y default-mysql-client libmysqlclient-dev postgresql-client libpq-dev sqlite3 libsqlite3-dev redis-tools ffmpeg mupdf mupdf-tools poppler-utils libvips
    - name: Configure databases
      run: |
        echo "Redis"
        redis-cli config set stop-writes-on-bgsave-error no
        redis-cli config set save ""

        echo "Postgres"
        psql -h localhost -c "create database activerecord_unittest;" -U postgres
        psql -h localhost -c "create database activerecord_unittest2;" -U postgres

        echo "MySQL"
        mysql --user=root --password=secret --host=127.0.0.1 --port=99 -e "create user rails;"
        mysql --user=root --password=secret --host=127.0.0.1 --port=99 -e "grant all privileges on activerecord_unittest.* to rails;"
        mysql --user=root --password=secret --host=127.0.0.1 --port=99 -e "grant all privileges on activerecord_unittest2.* to rails;"
        mysql --user=root --password=secret --host=127.0.0.1 --port=99 -e "grant all privileges on inexistent_activerecord_unittest.* to rails;"
        mysql --user=root --password=secret --host=127.0.0.1 --port=99 -e "create database activerecord_unittest default character set utf8mb4;"
        mysql --user=root --password=secret --host=127.0.0.1 --port=99 -e "create database activerecord_unittest2 default character set utf8mb4;"
    - name: Install Node
      uses: actions/setup-node@v1
      with:
        node-version: 12.x
    - name: Install NPM
      run: |
        npm install
    - name: Run tests
      run: |
        IFS=: read -a GEM <<<"${{ matrix.gem }}"
        DATABASE="${GEM[1]}"
        export PGHOST=localhost PGUSER=postgres
        cd "${GEM[0]}"
        if [ -z "$DATABASE" ]
        then
          bundle exec rake
        else
          bundle exec rake "test:${GEM[1]}"
        fi
      env:
        MYSQL_HOST: 127.0.0.1
        MYSQL_PORT: 99
